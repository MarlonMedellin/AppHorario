---
import { fetchMatrizFlexible } from "../services/sheetService";
import Layout from "../layouts/Layout.astro";
import DayTabs from "../components/DayTabs.astro";
import HorarioTable from "../components/HorarioTable.astro";

// Fetch data
const cleanData = await fetchMatrizFlexible();
const currentDay = null;

// Get unique asesores for filter
const uniqueAsesores = [
    ...new Set(cleanData.map((item) => item.Asesor).filter(Boolean)),
].sort();
---

<Layout title="Horario Personal - HorariosQuedate">
    <script is:inline>
        // CLIENT-SIDE ROUTE PROTECTION
        // Verificar sesión antes de mostrar nada.
        (function () {
            const session = localStorage.getItem("horarios_session");
            if (!session) {
                // No logueado. Mostrar mensaje y redirigir.
                alert("Debes iniciar sesión para acceder a esta página");
                window.location.href = "/";
            }
        })();
    </script>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">
            Mi Horario Personal
        </h1>

        <!-- Asesor Filter Section -->
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 p-6 mb-6"
        >
            <div class="flex items-center justify-between mb-4">
                <h3
                    class="text-sm font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider"
                >
                    Asesores
                </h3>
                <button
                    id="clear-asesor-filter"
                    class="text-xs px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-red-100 dark:hover:bg-red-900/20 hover:text-red-600 dark:hover:text-red-400 transition font-medium hidden"
                    title="Limpiar filtro de asesores"
                >
                    <span class="flex items-center gap-1">
                        <svg
                            class="w-3.5 h-3.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Limpiar
                    </span>
                </button>
            </div>

            <div
                id="asesor-filter-container"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"
            >
                {
                    uniqueAsesores.map((asesor) => (
                        <label class="flex items-center space-x-2 cursor-pointer group">
                            <input
                                type="checkbox"
                                value={asesor}
                                class="asesor-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 transition"
                            />
                            <span class="text-sm text-slate-700 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">
                                {asesor}
                            </span>
                        </label>
                    ))
                }
            </div>
        </div>

        <DayTabs activeDay={currentDay} />

        <!-- Embed Data for Client Script -->
        <div
            id="horario-data"
            data-json={JSON.stringify(cleanData)}
            class="hidden"
        >
        </div>

        <!-- Table -->
        <HorarioTable data={cleanData} />
    </div>
</Layout>

<script>
    import { isAuthenticated, getCurrentUser } from "../services/authService";

    // Check authentication
    if (!isAuthenticated()) {
        // Redirect to home with message
        alert("Debes iniciar sesión para acceder a esta página");
        window.location.href = "/";
    }

    // Asesor filter logic
    const selectedAsesores = new Set<string>();
    const checkboxes = document.querySelectorAll(".asesor-checkbox");
    const clearBtn = document.getElementById("clear-asesor-filter");

    // Read embedded data
    const dataElement = document.getElementById("horario-data");
    const allData = dataElement
        ? JSON.parse(dataElement.dataset.json || "[]")
        : [];

    // Listen for checkbox changes
    checkboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", (e) => {
            const target = e.target as HTMLInputElement;
            const asesor = target.value;

            if (target.checked) {
                selectedAsesores.add(asesor);
            } else {
                selectedAsesores.delete(asesor);
            }

            dispatchFilterEvent();
            toggleClearButton();
        });
    });

    // Clear filter button
    clearBtn?.addEventListener("click", () => {
        selectedAsesores.clear();
        checkboxes.forEach((cb) => {
            (cb as HTMLInputElement).checked = false;
        });
        dispatchFilterEvent();
        toggleClearButton();
    });

    // Dispatch event to HorarioTable
    function dispatchFilterEvent() {
        let filteredResult = null;

        if (selectedAsesores.size > 0) {
            // Filter the master data to strictly match selected advisors
            filteredResult = allData.filter((item: any) =>
                selectedAsesores.has(item.Asesor),
            );
        }

        // Dispatch 'filters-applied' which HorarioTable listens to
        // If null, it shows all (subject to Day filter). If array, it shows intersection.
        const event = new CustomEvent("filters-applied", {
            detail: filteredResult,
        });
        document.dispatchEvent(event);
    }

    // Toggle clear button visibility
    function toggleClearButton() {
        if (selectedAsesores.size > 0) {
            clearBtn?.classList.remove("hidden");
        } else {
            clearBtn?.classList.add("hidden");
        }
    }

    // Update visible count in UI (Label)
    // HorarioTable updates the "Resultados" count internally?
    // Yes, HorarioTable script has updateCount(visibleCount).
    // But we have "count-display" in HorarioTable.astro too.
    // The previous script had updateVisibleCount().
    // We can rely on HorarioTable to update the count!
    // But wait, the previous script updated "count-display".
    // HorarioTable ALSO updates "count-display".
    // So we don't need to do it here manually anymore.

    // Highlight user's own sessions
    const user = getCurrentUser();
    if (user) {
        document.addEventListener("DOMContentLoaded", () => {
            const rows = document.querySelectorAll("[data-asesor]");
            rows.forEach((row) => {
                const asesor = (row as HTMLElement).dataset.asesor;
                // Highlight user's own sessions
                if (asesor === user.nombre) {
                    row.classList.add(
                        "bg-blue-50",
                        "dark:bg-blue-900/20",
                        "border-l-4",
                        "border-blue-600",
                    );
                }
            });
        });
    }
</script>
