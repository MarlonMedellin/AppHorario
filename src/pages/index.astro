---
import { fetchMatrizFlexible } from "../services/sheetService";
import DashboardLayout from "../layouts/DashboardLayout.astro";
import SummaryCards from "../components/dashboard/SummaryCards.astro";
import AnnouncementCard from "../components/dashboard/AnnouncementCard.astro";
import HorarioTable from "../components/HorarioTable.astro";
import SidebarFilters from "../components/SidebarFilters.astro";
import DayTabs from "../components/DayTabs.astro";
import type { ScheduleItem } from "../features/schedule/types";
import { getTodayName } from "../features/schedule/filters";

const allData = (await fetchMatrizFlexible()) as ScheduleItem[];
const allowedTipos = [
	"Asesoría Académica",
	"Asesoría Academica",
	"Asesoría Virtual",
];
const publicData = allData.filter(
	(item) => typeof item.Tipo === "string" && allowedTipos.includes(item.Tipo),
);
const currentDay = getTodayName() === "Domingo" ? "Lunes" : getTodayName();
---

<DashboardLayout
	title="Quédate en Colmayor | Ingreso, Permanencia y Graduación"
>
	<div class="relative min-h-screen flex flex-col">
		<!-- Title Section -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-[var(--color-text-main)]">
				Quédate en Colmayor
			</h1>
			<p class="text-gray-500 dark:text-gray-400">
				Ingreso, Permanencia y Graduación
			</p>
		</div>

		<!-- Top Section: Announcements -->
		<AnnouncementCard />

		<!-- Widgets Row -->
		<SummaryCards />

		<!-- Main Layout: Sidebar + Table -->
		<div class="flex min-h-screen gap-6">
			<aside
				class="w-72 flex-shrink-0 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hidden md:block h-fit"
			>
				<SidebarFilters allData={publicData} />
			</aside>

			<main class="flex-1">
				<div class="mb-6">
					<input
						id="index-search-input"
						type="text"
						placeholder="Buscar por asesor, asignatura, sede..."
						class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
					/>
				</div>

				<DayTabs activeDay={currentDay} />

				<div
					class="bg-[var(--color-bg-card)] rounded-2xl shadow-sm border border-[var(--color-border)] p-6 mb-8"
				>
					<div class="flex items-center justify-between mb-6">
						<h3
							class="text-lg font-bold text-[var(--color-text-main)]"
						>
							Horario de Hoy
						</h3>
					</div>
					<HorarioTable data={publicData} />
				</div>
			</main>
		</div>
	</div>
</DashboardLayout>

<script is:inline define:vars={{ currentDay }}>
	document.addEventListener("DOMContentLoaded", () => {
		const searchInput = document.getElementById("index-search-input");

		if (searchInput) {
			searchInput.addEventListener("input", () => {
				const event = new CustomEvent("search-changed", {
					detail: searchInput.value || "",
				});
				document.dispatchEvent(event);
			});
		}

		const dayEvent = new CustomEvent("day-changed", { detail: currentDay });
		document.dispatchEvent(dayEvent);
	});
</script>
