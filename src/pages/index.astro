---
import { fetchMatrizFlexible } from "../services/sheetService";
import Layout from "../layouts/Layout.astro";
import DayTabs from "../components/DayTabs.astro";
import SidebarFilters from "../components/SidebarFilters.astro";
import HorarioTable from "../components/HorarioTable.astro";

// Fetch data using the service
const cleanData = await fetchMatrizFlexible();

// Set currentDay to null to show all days by default (Todo tab active)
const currentDay = null;
---

<Layout title="Dashboard - HorariosQuedate">
	<div class="flex min-h-screen">
		<!-- Sidebar -->
		<aside
			class="w-72 flex-shrink-0 bg-white dark:bg-gray-800 shadow-lg hidden md:block"
		>
			<SidebarFilters allData={cleanData} showOtherSedes={false} />
		</aside>

		<!-- Main Content -->
		<main class="flex-1 p-6">
			<!-- Search Box -->
			<div class="mb-6">
				<input
					type="text"
					id="search-box"
					placeholder="Buscar por asesor, asignatura, sede..."
					class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
				/>
			</div>

			<!-- Day Tabs -->
			<DayTabs activeDay={currentDay} />

			<!-- Results Count -->
			<div class="mb-4 text-sm text-gray-600 dark:text-gray-400">
				Mostrando <span
					id="count"
					class="font-bold text-blue-600 dark:text-blue-400"
					>{cleanData.length}</span
				> registros
			</div>

			<!-- Table -->
			<HorarioTable data={cleanData} />
		</main>
	</div>

	<script>
		// Search functionality
		const searchBox = document.getElementById(
			"search-box",
		) as HTMLInputElement;
		searchBox?.addEventListener("input", (e) => {
			const term = (e.target as HTMLInputElement).value;
			const event = new CustomEvent("search-changed", { detail: term });
			document.dispatchEvent(event);
		});
	</script>
</Layout>
