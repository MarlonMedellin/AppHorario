---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import SummaryCards from "../components/dashboard/SummaryCards.astro";
import AnnouncementCard from "../components/dashboard/AnnouncementCard.astro";
import DashboardTable from "../components/Dashboard.jsx"; // Re-using the logic, but wrapped in new design
---

<DashboardLayout
	title="Quédate en Colmayor | Ingreso, Permanencia y Graduación"
>
	<div class="relative min-h-screen flex flex-col">
		<!-- Title Section -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-[var(--color-text-main)]">
				Quédate en Colmayor
			</h1>
			<p class="text-gray-500 dark:text-gray-400">
				Ingreso, Permanencia y Graduación
			</p>
		</div>

		<!-- Top Section: Announcements -->
		<AnnouncementCard />

		<!-- Widgets Row -->
		<SummaryCards />

		<!-- Main Layout: Table Full Width -->
		<div class="flex flex-col gap-8 mt-8 pb-12 flex-1">
			<!-- Main Content: Schedule -->
			<div class="w-full">
				<div
					class="bg-[var(--color-bg-card)] rounded-2xl shadow-sm border border-[var(--color-border)] p-6 mb-8"
				>
					<div class="flex items-center justify-between mb-6">
						<h3
							class="text-lg font-bold text-[var(--color-text-main)]"
						>
							Horario de Hoy
						</h3>
						<div class="flex gap-2">
							<span
								id="en-curso-badge"
								class="px-3 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full hidden"
								>En curso</span
							>
						</div>
					</div>
					<!-- Schedule Table -->
					<DashboardTable client:only="react" />
				</div>
			</div>
		</div>
	</div>
</DashboardLayout>

<script>
	import { isTimeSlotActive, isTodayName } from "../utils/timeUtils";

	function updateBadge() {
		const badge = document.getElementById("en-curso-badge");
		if (!badge) return;

		const rows = document.querySelectorAll(".horario-table tbody tr");
		let hasActive = false;

		rows.forEach((row) => {
			const cells = row.querySelectorAll("td");
			if (cells.length < 5) return;

			const timeCell = cells[0];
			const spans = timeCell.querySelectorAll("span");
			if (spans.length < 2) return;

			const horaInicio = spans[0].textContent?.trim() || "";
			const horaFin = spans[1].textContent?.trim() || "";

			const dayCell = cells[4];
			const daySpan = dayCell.querySelector("span");
			const dayAbbr = daySpan?.textContent?.trim() || "";

			const dayMap: Record<string, string> = {
				Dom: "Domingo",
				Lun: "Lunes",
				Mar: "Martes",
				Mié: "Miércoles",
				Jue: "Jueves",
				Vie: "Viernes",
				Sáb: "Sábado",
			};
			const dayName = dayMap[dayAbbr] || "";

			if (isTodayName(dayName) && isTimeSlotActive(horaInicio, horaFin)) {
				hasActive = true;
			}
		});

		badge.classList.toggle("hidden", !hasActive);
	}

	// Run after React renders (small delay for client:only)
	setTimeout(updateBadge, 2000);
	setInterval(updateBadge, 60000);
</script>
